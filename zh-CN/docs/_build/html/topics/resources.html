

<!DOCTYPE html>
<html class="writer-html5" lang="zh" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Defining Resources &mdash; IdentityServer4 1.0.0 文档</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
    <link rel="next" title="Defining Clients" href="clients.html" />
    <link rel="prev" title="Startup" href="startup.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> IdentityServer4
          

          
          </a>

          
            
            
              <div class="version">
                1.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">介绍</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../intro/big_picture.html">大图</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/terminology.html">术语</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/specs.html">支持的规范</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/packaging.html">打包和构建</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/support.html">支持和咨询选项</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/test.html">演示服务器</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/contributing.html">贡献</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">快速入门</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quickstarts/0_overview.html">概述</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstarts/1_client_credentials.html">使用客户端凭据保护 API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstarts/2_interactive_aspnetcore.html">使用 ASP.NET Core 的交互式应用程序</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstarts/3_aspnetcore_and_apis.html">ASP.NET Core 和 API 访问</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstarts/4_javascript_client.html">添加 JavaScript 客户端</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstarts/5_entityframework.html">使用 EntityFramework Core 获取配置和操作数据</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstarts/6_aspnet_identity.html">Using ASP.NET Core Identity</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">主题</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="startup.html">Startup</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Defining Resources</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#identity-resources">Identity Resources</a></li>
<li class="toctree-l2"><a class="reference internal" href="#apis">APIs</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#scopes">Scopes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#authorization-based-on-scopes">Authorization based on Scopes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#parameterized-scopes">Parameterized Scopes</a></li>
<li class="toctree-l3"><a class="reference internal" href="#api-resources">API Resources</a></li>
<li class="toctree-l3"><a class="reference internal" href="#migration-steps-to-v4">Migration steps to v4</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="clients.html">Defining Clients</a></li>
<li class="toctree-l1"><a class="reference internal" href="signin.html">Sign-in</a></li>
<li class="toctree-l1"><a class="reference internal" href="signin_external_providers.html">Sign-in with External Identity Providers</a></li>
<li class="toctree-l1"><a class="reference internal" href="windows.html">Windows Authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="signout.html">Sign-out</a></li>
<li class="toctree-l1"><a class="reference internal" href="signout_external_providers.html">Sign-out of External Identity Providers</a></li>
<li class="toctree-l1"><a class="reference internal" href="signout_federated.html">Federated Sign-out</a></li>
<li class="toctree-l1"><a class="reference internal" href="federation_gateway.html">Federation Gateway</a></li>
<li class="toctree-l1"><a class="reference internal" href="consent.html">Consent</a></li>
<li class="toctree-l1"><a class="reference internal" href="apis.html">Protecting APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="deployment.html">Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="logging.html">Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="events.html">Events</a></li>
<li class="toctree-l1"><a class="reference internal" href="crypto.html">Cryptography, Keys and HTTPS</a></li>
<li class="toctree-l1"><a class="reference internal" href="grant_types.html">Grant Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="client_authentication.html">Client Authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="extension_grants.html">Extension Grants</a></li>
<li class="toctree-l1"><a class="reference internal" href="resource_owner.html">Resource Owner Password Validation</a></li>
<li class="toctree-l1"><a class="reference internal" href="refresh_tokens.html">Refresh Tokens</a></li>
<li class="toctree-l1"><a class="reference internal" href="reference_tokens.html">Reference Tokens</a></li>
<li class="toctree-l1"><a class="reference internal" href="persisted_grants.html">Persisted Grants</a></li>
<li class="toctree-l1"><a class="reference internal" href="pop.html">Proof-of-Possession Access Tokens</a></li>
<li class="toctree-l1"><a class="reference internal" href="mtls.html">Mutual TLS</a></li>
<li class="toctree-l1"><a class="reference internal" href="request_object.html">Authorize Request Objects</a></li>
<li class="toctree-l1"><a class="reference internal" href="custom_token_request_validation.html">Custom Token Request Validation and Issuance</a></li>
<li class="toctree-l1"><a class="reference internal" href="cors.html">CORS</a></li>
<li class="toctree-l1"><a class="reference internal" href="discovery.html">Discovery</a></li>
<li class="toctree-l1"><a class="reference internal" href="add_apis.html">Adding more API Endpoints</a></li>
<li class="toctree-l1"><a class="reference internal" href="add_protocols.html">Adding new Protocols</a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html">Tools</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">端点</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../endpoints/discovery.html">Discovery Endpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../endpoints/authorize.html">Authorize Endpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../endpoints/token.html">Token Endpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../endpoints/userinfo.html">UserInfo Endpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../endpoints/device_authorization.html">Device Authorization Endpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../endpoints/introspection.html">Introspection Endpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../endpoints/revocation.html">Revocation Endpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../endpoints/endsession.html">End Session Endpoint</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">参考</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../reference/options.html">IdentityServer Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/identity_resource.html">Identity Resource</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/api_scope.html">API Scope</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/api_resource.html">API Resource</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/client.html">Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/grant_validation_result.html">GrantValidationResult</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/profileservice.html">Profile Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/interactionservice.html">IdentityServer Interaction Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/deviceflow_interactionservice.html">Device Flow Interaction Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/ef.html">Entity Framework Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/aspnet_identity.html">ASP.NET Identity Support</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">杂项</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../misc/training.html">Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/blogs.html">Blog posts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/videos.html">Videos</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">IdentityServer4</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Defining Resources</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/topics/resources.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="defining-resources">
<h1>Defining Resources<a class="headerlink" href="#defining-resources" title="永久链接至标题">¶</a></h1>
<p>The ultimate job of an OpenID Connect/OAuth token service is to control access to resources.</p>
<p>The two fundamental resource types in IdentityServer are:</p>
<ul class="simple">
<li><p><strong>identity resources:</strong> represent claims about a user like user ID, display name, email address etc…</p></li>
<li><p><strong>API resources:</strong> represent functionality a client wants to access. Typically, they are HTTP-based endpoints (aka APIs), but could be also message queuing endpoints or similar.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>You can define resources using a C# object model - or load them from a data store. An implementation of <code class="docutils literal notranslate"><span class="pre">IResourceStore</span></code> deals with these low-level details. For this document we are using the in-memory implementation.</p>
</div>
<div class="section" id="identity-resources">
<h2>Identity Resources<a class="headerlink" href="#identity-resources" title="永久链接至标题">¶</a></h2>
<p>An identity resource is a named group of claims that can be requested using the <em>scope</em> parameter.</p>
<p>The OpenID Connect specification <a class="reference external" href="https://openid.net/specs/openid-connect-core-1_0.html#ScopeClaims">suggests</a> a couple of standard
scope name to claim type mappings that might be useful to you for inspiration, but you can freely design them yourself.</p>
<p>One of them is actually mandatory, the <em>openid</em> scope, which tells the provider to return the <em>sub</em> (subject id) claim in the identity token.</p>
<p>This is how you could define the openid scope in code:</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">static</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">IdentityResource</span><span class="p">&gt;</span> <span class="n">GetIdentityResources</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">IdentityResource</span><span class="p">&gt;</span>
    <span class="p">{</span>
        <span class="k">new</span> <span class="nf">IdentityResource</span><span class="p">(</span>
            <span class="n">name</span><span class="p">:</span> <span class="s">&quot;openid&quot;</span><span class="p">,</span>
            <span class="n">userClaims</span><span class="p">:</span> <span class="k">new</span><span class="p">[]</span> <span class="p">{</span> <span class="s">&quot;sub&quot;</span> <span class="p">},</span>
            <span class="n">displayName</span><span class="p">:</span> <span class="s">&quot;Your user identifier&quot;</span><span class="p">)</span>
    <span class="p">};</span>
<span class="p">}</span>
</pre></div>
</div>
<p>But since this is one of the standard scopes from the spec you can shorten that to:</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">static</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">IdentityResource</span><span class="p">&gt;</span> <span class="n">GetIdentityResources</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">IdentityResource</span><span class="p">&gt;</span>
    <span class="p">{</span>
        <span class="k">new</span> <span class="n">IdentityResources</span><span class="p">.</span><span class="n">OpenId</span><span class="p">()</span>
    <span class="p">};</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>see the reference section for more information on <code class="docutils literal notranslate"><span class="pre">IdentityResource</span></code>.</p>
</div>
<p>The following example shows a custom identity resource called <em>profile</em> that represents the display name, email address and website claim:</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">static</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">IdentityResource</span><span class="p">&gt;</span> <span class="n">GetIdentityResources</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">IdentityResource</span><span class="p">&gt;</span>
    <span class="p">{</span>
        <span class="k">new</span> <span class="nf">IdentityResource</span><span class="p">(</span>
            <span class="n">name</span><span class="p">:</span> <span class="s">&quot;profile&quot;</span><span class="p">,</span>
            <span class="n">userClaims</span><span class="p">:</span> <span class="k">new</span><span class="p">[]</span> <span class="p">{</span> <span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="s">&quot;email&quot;</span><span class="p">,</span> <span class="s">&quot;website&quot;</span> <span class="p">},</span>
            <span class="n">displayName</span><span class="p">:</span> <span class="s">&quot;Your profile data&quot;</span><span class="p">)</span>
    <span class="p">};</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Once the resource is defined, you can give access to it to a client via the <code class="docutils literal notranslate"><span class="pre">AllowedScopes</span></code> option (other properties omitted):</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="kt">var</span> <span class="n">client</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Client</span>
<span class="p">{</span>
    <span class="n">ClientId</span> <span class="p">=</span> <span class="s">&quot;client&quot;</span><span class="p">,</span>

    <span class="n">AllowedScopes</span> <span class="p">=</span> <span class="p">{</span> <span class="s">&quot;openid&quot;</span><span class="p">,</span> <span class="s">&quot;profile&quot;</span> <span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
<p>The client can then request the resource using the scope parameter (other parameters omitted):</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="n">https</span><span class="p">:</span><span class="c1">//demo.identityserver.io/connect/authorize?client_id=client&amp;scope=openid profile</span>
</pre></div>
</div>
<p>IdentityServer will then use the scope names to create a list of requested claim types,
and present that to your implementation of the <a class="reference internal" href="../reference/profileservice.html#refprofileservice"><span class="std std-ref">profile service</span></a>.</p>
</div>
<div class="section" id="apis">
<h2>APIs<a class="headerlink" href="#apis" title="永久链接至标题">¶</a></h2>
<p>Designing your API surface can be a complicated task. IdentityServer provides a couple of primitives to help you with that.</p>
<p>The original OAuth 2.0 specification has the concept of scopes, which is just defined as <em>the scope of access</em> that the client requests.
Technically speaking, the <em>scope</em> parameter is a list of space delimited values - you need to provide the structure and semantics of it.</p>
<p>In more complex systems, often the notion of a <em>resource</em> is introduced. This might be e.g. a physical or logical API.
In turn each API can potentially have scopes as well. Some scopes might be exclusive to that resource, and some scopes might be shared.</p>
<p>Let's start with simple scopes first, and then we'll have a look how resources can help structure scopes.</p>
<div class="section" id="scopes">
<h3>Scopes<a class="headerlink" href="#scopes" title="永久链接至标题">¶</a></h3>
<p>Let's model something very simple - a system that has three logical operations <em>read</em>, <em>write</em>, and <em>delete</em>.</p>
<p>You can define them using the <code class="docutils literal notranslate"><span class="pre">ApiScope</span></code> class:</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">static</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">ApiScope</span><span class="p">&gt;</span> <span class="n">GetApiScopes</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">ApiScope</span><span class="p">&gt;</span>
    <span class="p">{</span>
        <span class="k">new</span> <span class="nf">ApiScope</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="s">&quot;read&quot;</span><span class="p">,</span>   <span class="n">displayName</span><span class="p">:</span> <span class="s">&quot;Read your data.&quot;</span><span class="p">),</span>
        <span class="k">new</span> <span class="nf">ApiScope</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="s">&quot;write&quot;</span><span class="p">,</span>  <span class="n">displayName</span><span class="p">:</span> <span class="s">&quot;Write your data.&quot;</span><span class="p">),</span>
        <span class="k">new</span> <span class="nf">ApiScope</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="s">&quot;delete&quot;</span><span class="p">,</span> <span class="n">displayName</span><span class="p">:</span> <span class="s">&quot;Delete your data.&quot;</span><span class="p">)</span>
    <span class="p">};</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You can then assign the scopes to various clients, e.g.:</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="kt">var</span> <span class="n">webViewer</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Client</span>
<span class="p">{</span>
    <span class="n">ClientId</span> <span class="p">=</span> <span class="s">&quot;web_viewer&quot;</span><span class="p">,</span>

    <span class="n">AllowedScopes</span> <span class="p">=</span> <span class="p">{</span> <span class="s">&quot;openid&quot;</span><span class="p">,</span> <span class="s">&quot;profile&quot;</span><span class="p">,</span> <span class="s">&quot;read&quot;</span> <span class="p">}</span>
<span class="p">};</span>

<span class="kt">var</span> <span class="n">mobileApp</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Client</span>
<span class="p">{</span>
    <span class="n">ClientId</span> <span class="p">=</span> <span class="s">&quot;mobile_app&quot;</span><span class="p">,</span>

    <span class="n">AllowedScopes</span> <span class="p">=</span> <span class="p">{</span> <span class="s">&quot;openid&quot;</span><span class="p">,</span> <span class="s">&quot;profile&quot;</span><span class="p">,</span> <span class="s">&quot;read&quot;</span><span class="p">,</span> <span class="s">&quot;write&quot;</span><span class="p">,</span> <span class="s">&quot;delete&quot;</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="authorization-based-on-scopes">
<h3>Authorization based on Scopes<a class="headerlink" href="#authorization-based-on-scopes" title="永久链接至标题">¶</a></h3>
<p>When a client asks for a scope (and that scope is allowed via configuration and not denied via consent),
the value of that scope will be included in the resulting access token as a claim of type <em>scope</em> (for both JWTs and introspection), e.g.:</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s">&quot;typ&quot;</span><span class="p">:</span> <span class="s">&quot;at+jwt&quot;</span>
<span class="p">}.</span>
<span class="p">{</span>
    <span class="s">&quot;client_id&quot;</span><span class="p">:</span> <span class="s">&quot;mobile_app&quot;</span><span class="p">,</span>
    <span class="s">&quot;sub&quot;</span><span class="p">:</span> <span class="s">&quot;123&quot;</span><span class="p">,</span>

    <span class="s">&quot;scope&quot;</span><span class="p">:</span> <span class="s">&quot;read write delete&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The consumer of the access token can use that data to make sure that the client is actually allowed to invoke the corresponding functionality.</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>Be aware, that scopes are purely for authorizing clients - not users. IOW - the <em>write</em> scope allows the client to invoke the functionality associated with that. Still that client can most probably only write the data the belongs to the current user. This additional user centric authorization is application logic and not covered by OAuth.</p>
</div>
<p>You can add more identity information about the user by deriving additional claims from the scope request. The following scope definition tells the configuration system,
that when a <em>write</em> scope gets granted, the <em>user_level</em> claim should be added to the access token:</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="kt">var</span> <span class="n">writeScope</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ApiScope</span><span class="p">(</span>
    <span class="n">name</span><span class="p">:</span> <span class="s">&quot;write&quot;</span><span class="p">,</span>
    <span class="n">displayName</span><span class="p">:</span> <span class="s">&quot;Write your data.&quot;</span><span class="p">,</span>
    <span class="n">userClaims</span><span class="p">:</span> <span class="k">new</span><span class="p">[]</span> <span class="p">{</span> <span class="s">&quot;user_level&quot;</span> <span class="p">});</span>
</pre></div>
</div>
<p>This will pass the <em>user_level</em> claim as a requested claim type to the profile service,
so that the consumer of the access token can use this data as input for authorization decisions or business logic.</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>When using the scope-only model, no aud (audience) claim will be added to the token, since this concept does not apply. If you need an aud claim, you can enable the <code class="docutils literal notranslate"><span class="pre">EmitStaticAudience</span></code> setting on the options. This will emit an aud claim in the <code class="docutils literal notranslate"><span class="pre">issuer_name/resources</span></code> format. If you need more control of the aud claim, use API resources.</p>
</div>
</div>
<div class="section" id="parameterized-scopes">
<h3>Parameterized Scopes<a class="headerlink" href="#parameterized-scopes" title="永久链接至标题">¶</a></h3>
<p>Sometimes scopes have a certain structure, e.g. a scope name with an additional parameter: <em>transaction:id</em> or <em>read_patient:patientid</em>.</p>
<p>In this case you would create a scope without the parameter part and assign that name to a client, but in addition provide some logic to parse the structure
of the scope at runtime using the <code class="docutils literal notranslate"><span class="pre">IScopeParser</span></code> interface or by deriving from our default implementation, e.g.:</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">class</span> <span class="nc">ParameterizedScopeParser</span> <span class="p">:</span> <span class="n">DefaultScopeParser</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">ParameterizedScopeParser</span><span class="p">(</span><span class="n">ILogger</span><span class="p">&lt;</span><span class="n">DefaultScopeParser</span><span class="p">&gt;</span> <span class="n">logger</span><span class="p">)</span> <span class="p">:</span> <span class="k">base</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">override</span> <span class="k">void</span> <span class="nf">ParseScopeValue</span><span class="p">(</span><span class="n">ParseScopeContext</span> <span class="n">scopeContext</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">const</span> <span class="kt">string</span> <span class="n">transactionScopeName</span> <span class="p">=</span> <span class="s">&quot;transaction&quot;</span><span class="p">;</span>
        <span class="k">const</span> <span class="kt">string</span> <span class="n">separator</span> <span class="p">=</span> <span class="s">&quot;:&quot;</span><span class="p">;</span>
        <span class="k">const</span> <span class="kt">string</span> <span class="n">transactionScopePrefix</span> <span class="p">=</span> <span class="n">transactionScopeName</span> <span class="p">+</span> <span class="n">separator</span><span class="p">;</span>

        <span class="kt">var</span> <span class="n">scopeValue</span> <span class="p">=</span> <span class="n">scopeContext</span><span class="p">.</span><span class="n">RawValue</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">scopeValue</span><span class="p">.</span><span class="n">StartsWith</span><span class="p">(</span><span class="n">transactionScopePrefix</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="c1">// we get in here with a scope like &quot;transaction:something&quot;</span>
            <span class="kt">var</span> <span class="n">parts</span> <span class="p">=</span> <span class="n">scopeValue</span><span class="p">.</span><span class="n">Split</span><span class="p">(</span><span class="n">separator</span><span class="p">,</span> <span class="n">StringSplitOptions</span><span class="p">.</span><span class="n">RemoveEmptyEntries</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">parts</span><span class="p">.</span><span class="n">Length</span> <span class="p">==</span> <span class="m">2</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">scopeContext</span><span class="p">.</span><span class="n">SetParsedValues</span><span class="p">(</span><span class="n">transactionScopeName</span><span class="p">,</span> <span class="n">parts</span><span class="p">[</span><span class="m">1</span><span class="p">]);</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">scopeContext</span><span class="p">.</span><span class="n">SetError</span><span class="p">(</span><span class="s">&quot;transaction scope missing transaction parameter value&quot;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">scopeValue</span> <span class="p">!=</span> <span class="n">transactionScopeName</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// we get in here with a scope not like &quot;transaction&quot;</span>
            <span class="k">base</span><span class="p">.</span><span class="n">ParseScopeValue</span><span class="p">(</span><span class="n">scopeContext</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">else</span>
        <span class="p">{</span>
            <span class="c1">// we get in here with a scope exactly &quot;transaction&quot;, which is to say we&#39;re ignoring it</span>
            <span class="c1">// and not including it in the results</span>
            <span class="n">scopeContext</span><span class="p">.</span><span class="n">SetIgnore</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You then have access to the parsed value throughout the pipeline, e.g. in the profile service:</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">class</span> <span class="nc">HostProfileService</span> <span class="p">:</span> <span class="n">IProfileService</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">override</span> <span class="k">async</span> <span class="n">Task</span> <span class="nf">GetProfileDataAsync</span><span class="p">(</span><span class="n">ProfileDataRequestContext</span> <span class="n">context</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">transaction</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">RequestedResources</span><span class="p">.</span><span class="n">ParsedScopes</span><span class="p">.</span><span class="n">FirstOrDefault</span><span class="p">(</span><span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span><span class="p">.</span><span class="n">ParsedName</span> <span class="p">==</span> <span class="s">&quot;transaction&quot;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">transaction</span><span class="p">?.</span><span class="n">ParsedParameter</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">context</span><span class="p">.</span><span class="n">IssuedClaims</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="k">new</span> <span class="n">Claim</span><span class="p">(</span><span class="s">&quot;transaction_id&quot;</span><span class="p">,</span> <span class="n">transaction</span><span class="p">.</span><span class="n">ParsedParameter</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="api-resources">
<h3>API Resources<a class="headerlink" href="#api-resources" title="永久链接至标题">¶</a></h3>
<p>When the API surface gets larger, a flat list of scopes like the one used above might not be feasible.</p>
<p>You typically need to introduce some sort of namespacing to organize the scope names, and maybe you also want to group them together and
get some higher-level constructs like an <em>audience</em> claim in access tokens.
You might also have scenarios, where multiple resources should support the same scope names, whereas sometime you explicitly want to isolate a scope to a certain resource.</p>
<p>In IdentityServer, the <code class="docutils literal notranslate"><span class="pre">ApiResource</span></code> class allows some additional organization. Let's use the following scope definition:</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">static</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">ApiScope</span><span class="p">&gt;</span> <span class="n">GetApiScopes</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">ApiScope</span><span class="p">&gt;</span>
    <span class="p">{</span>
        <span class="c1">// invoice API specific scopes</span>
        <span class="k">new</span> <span class="nf">ApiScope</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="s">&quot;invoice.read&quot;</span><span class="p">,</span>   <span class="n">displayName</span><span class="p">:</span> <span class="s">&quot;Reads your invoices.&quot;</span><span class="p">),</span>
        <span class="k">new</span> <span class="nf">ApiScope</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="s">&quot;invoice.pay&quot;</span><span class="p">,</span>    <span class="n">displayName</span><span class="p">:</span> <span class="s">&quot;Pays your invoices.&quot;</span><span class="p">),</span>

        <span class="c1">// customer API specific scopes</span>
        <span class="k">new</span> <span class="nf">ApiScope</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="s">&quot;customer.read&quot;</span><span class="p">,</span>    <span class="n">displayName</span><span class="p">:</span> <span class="s">&quot;Reads you customers information.&quot;</span><span class="p">),</span>
        <span class="k">new</span> <span class="nf">ApiScope</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="s">&quot;customer.contact&quot;</span><span class="p">,</span> <span class="n">displayName</span><span class="p">:</span> <span class="s">&quot;Allows contacting one of your customers.&quot;</span><span class="p">),</span>

        <span class="c1">// shared scope</span>
        <span class="k">new</span> <span class="nf">ApiScope</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="s">&quot;manage&quot;</span><span class="p">,</span> <span class="n">displayName</span><span class="p">:</span> <span class="s">&quot;Provides administrative access to invoice and customer data.&quot;</span><span class="p">)</span>
    <span class="p">};</span>
<span class="p">}</span>
</pre></div>
</div>
<p>With <code class="docutils literal notranslate"><span class="pre">ApiResource</span></code> you can now create two logical APIs and their corresponding scopes:</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">static</span> <span class="k">readonly</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">ApiResource</span><span class="p">&gt;</span> <span class="n">GetApiResources</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">ApiResource</span><span class="p">&gt;</span>
    <span class="p">{</span>
        <span class="k">new</span> <span class="nf">ApiResource</span><span class="p">(</span><span class="s">&quot;invoice&quot;</span><span class="p">,</span> <span class="s">&quot;Invoice API&quot;</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Scopes</span> <span class="p">=</span> <span class="p">{</span> <span class="s">&quot;invoice.read&quot;</span><span class="p">,</span> <span class="s">&quot;invoice.pay&quot;</span><span class="p">,</span> <span class="s">&quot;manage&quot;</span> <span class="p">}</span>
        <span class="p">},</span>

        <span class="k">new</span> <span class="nf">ApiResource</span><span class="p">(</span><span class="s">&quot;customer&quot;</span><span class="p">,</span> <span class="s">&quot;Customer API&quot;</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">Scopes</span> <span class="p">=</span> <span class="p">{</span> <span class="s">&quot;customer.read&quot;</span><span class="p">,</span> <span class="s">&quot;customer.contact&quot;</span><span class="p">,</span> <span class="s">&quot;manage&quot;</span> <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">};</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Using the API resource grouping gives you the following additional features</p>
<ul class="simple">
<li><p>support for the JWT <em>aud</em> claim. The value(s) of the audience claim will be the name of the API resource(s)</p></li>
<li><p>support for adding common user claims across all contained scopes</p></li>
<li><p>support for introspection by assigning an API secret to the resource</p></li>
<li><p>support for configuring the access token signing algorithm for the resource</p></li>
</ul>
<p>Let's have a look at some example access tokens for the above resource configuration.</p>
<p><strong>Client requests</strong> invoice.read and invoice.pay:</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s">&quot;typ&quot;</span><span class="p">:</span> <span class="s">&quot;at+jwt&quot;</span>
<span class="p">}.</span>
<span class="p">{</span>
    <span class="s">&quot;client_id&quot;</span><span class="p">:</span> <span class="s">&quot;client&quot;</span><span class="p">,</span>
    <span class="s">&quot;sub&quot;</span><span class="p">:</span> <span class="s">&quot;123&quot;</span><span class="p">,</span>

    <span class="s">&quot;aud&quot;</span><span class="p">:</span> <span class="s">&quot;invoice&quot;</span><span class="p">,</span>
    <span class="s">&quot;scope&quot;</span><span class="p">:</span> <span class="s">&quot;invoice.read invoice.pay&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Client requests</strong> invoice.read and customer.read:</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s">&quot;typ&quot;</span><span class="p">:</span> <span class="s">&quot;at+jwt&quot;</span>
<span class="p">}.</span>
<span class="p">{</span>
    <span class="s">&quot;client_id&quot;</span><span class="p">:</span> <span class="s">&quot;client&quot;</span><span class="p">,</span>
    <span class="s">&quot;sub&quot;</span><span class="p">:</span> <span class="s">&quot;123&quot;</span><span class="p">,</span>

    <span class="s">&quot;aud&quot;</span><span class="p">:</span> <span class="p">[</span> <span class="s">&quot;invoice&quot;</span><span class="p">,</span> <span class="s">&quot;customer&quot;</span> <span class="p">]</span>
    <span class="s">&quot;scope&quot;</span><span class="p">:</span> <span class="s">&quot;invoice.read customer.read&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Client requests</strong> manage:</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s">&quot;typ&quot;</span><span class="p">:</span> <span class="s">&quot;at+jwt&quot;</span>
<span class="p">}.</span>
<span class="p">{</span>
    <span class="s">&quot;client_id&quot;</span><span class="p">:</span> <span class="s">&quot;client&quot;</span><span class="p">,</span>
    <span class="s">&quot;sub&quot;</span><span class="p">:</span> <span class="s">&quot;123&quot;</span><span class="p">,</span>

    <span class="s">&quot;aud&quot;</span><span class="p">:</span> <span class="p">[</span> <span class="s">&quot;invoice&quot;</span><span class="p">,</span> <span class="s">&quot;customer&quot;</span> <span class="p">]</span>
    <span class="s">&quot;scope&quot;</span><span class="p">:</span> <span class="s">&quot;manage&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="migration-steps-to-v4">
<h3>Migration steps to v4<a class="headerlink" href="#migration-steps-to-v4" title="永久链接至标题">¶</a></h3>
<p>As described above, starting with v4, scopes have their own definition and can optionally be referenced by resources.
Before v4, scopes were always contained within a resource.</p>
<p>To migrate to v4 you need to split up scope and resource registration, typically by first registering all your scopes
(e.g. using the <code class="docutils literal notranslate"><span class="pre">AddInMemoryApiScopes</span></code> method), and then register the API resources (if any) afterwards.
The API resources will then reference the prior registered scopes by name.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="clients.html" class="btn btn-neutral float-right" title="Defining Clients" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="startup.html" class="btn btn-neutral float-left" title="Startup" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; 版权所有 2020, Brock Allen &amp; Dominick Baier.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>