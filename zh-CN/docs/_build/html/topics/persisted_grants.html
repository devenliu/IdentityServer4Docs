

<!DOCTYPE html>
<html class="writer-html5" lang="zh" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Persisted Grants &mdash; IdentityServer4 1.0.0 文档</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
    <link rel="next" title="Proof-of-Possession Access Tokens" href="pop.html" />
    <link rel="prev" title="Reference Tokens" href="reference_tokens.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> IdentityServer4
          

          
          </a>

          
            
            
              <div class="version">
                1.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">介绍</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../intro/big_picture.html">大图</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/terminology.html">术语</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/specs.html">支持的规范</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/packaging.html">打包和构建</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/support.html">支持和咨询选项</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/test.html">演示服务器</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/contributing.html">贡献</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">快速入门</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quickstarts/0_overview.html">概述</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstarts/1_client_credentials.html">使用客户端凭据保护 API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstarts/2_interactive_aspnetcore.html">使用 ASP.NET Core 的交互式应用程序</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstarts/3_aspnetcore_and_apis.html">ASP.NET Core 和 API 访问</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstarts/4_javascript_client.html">添加 JavaScript 客户端</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstarts/5_entityframework.html">使用 EntityFramework Core 获取配置和操作数据</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstarts/6_aspnet_identity.html">使用 ASP.NET Core Identity</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">主题</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="startup.html">Startup</a></li>
<li class="toctree-l1"><a class="reference internal" href="resources.html">定义资源</a></li>
<li class="toctree-l1"><a class="reference internal" href="clients.html">定义客户端</a></li>
<li class="toctree-l1"><a class="reference internal" href="signin.html">登录</a></li>
<li class="toctree-l1"><a class="reference internal" href="signin_external_providers.html">Sign-in with External Identity Providers</a></li>
<li class="toctree-l1"><a class="reference internal" href="windows.html">Windows Authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="signout.html">Sign-out</a></li>
<li class="toctree-l1"><a class="reference internal" href="signout_external_providers.html">Sign-out of External Identity Providers</a></li>
<li class="toctree-l1"><a class="reference internal" href="signout_federated.html">Federated Sign-out</a></li>
<li class="toctree-l1"><a class="reference internal" href="federation_gateway.html">Federation Gateway</a></li>
<li class="toctree-l1"><a class="reference internal" href="consent.html">Consent</a></li>
<li class="toctree-l1"><a class="reference internal" href="apis.html">Protecting APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="deployment.html">Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="logging.html">Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="events.html">Events</a></li>
<li class="toctree-l1"><a class="reference internal" href="crypto.html">Cryptography, Keys and HTTPS</a></li>
<li class="toctree-l1"><a class="reference internal" href="grant_types.html">Grant Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="client_authentication.html">Client Authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="extension_grants.html">Extension Grants</a></li>
<li class="toctree-l1"><a class="reference internal" href="resource_owner.html">Resource Owner Password Validation</a></li>
<li class="toctree-l1"><a class="reference internal" href="refresh_tokens.html">Refresh Tokens</a></li>
<li class="toctree-l1"><a class="reference internal" href="reference_tokens.html">Reference Tokens</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Persisted Grants</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#persisted-grant">Persisted Grant</a></li>
<li class="toctree-l2"><a class="reference internal" href="#grant-consumption">Grant Consumption</a></li>
<li class="toctree-l2"><a class="reference internal" href="#persisted-grant-service">Persisted Grant Service</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="pop.html">Proof-of-Possession Access Tokens</a></li>
<li class="toctree-l1"><a class="reference internal" href="mtls.html">Mutual TLS</a></li>
<li class="toctree-l1"><a class="reference internal" href="request_object.html">Authorize Request Objects</a></li>
<li class="toctree-l1"><a class="reference internal" href="custom_token_request_validation.html">Custom Token Request Validation and Issuance</a></li>
<li class="toctree-l1"><a class="reference internal" href="cors.html">CORS</a></li>
<li class="toctree-l1"><a class="reference internal" href="discovery.html">Discovery</a></li>
<li class="toctree-l1"><a class="reference internal" href="add_apis.html">Adding more API Endpoints</a></li>
<li class="toctree-l1"><a class="reference internal" href="add_protocols.html">Adding new Protocols</a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html">Tools</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">端点</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../endpoints/discovery.html">Discovery Endpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../endpoints/authorize.html">Authorize Endpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../endpoints/token.html">Token Endpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../endpoints/userinfo.html">UserInfo Endpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../endpoints/device_authorization.html">Device Authorization Endpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../endpoints/introspection.html">Introspection Endpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../endpoints/revocation.html">Revocation Endpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../endpoints/endsession.html">End Session Endpoint</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">参考</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../reference/options.html">IdentityServer Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/identity_resource.html">Identity Resource</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/api_scope.html">API Scope</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/api_resource.html">API Resource</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/client.html">Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/grant_validation_result.html">GrantValidationResult</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/profileservice.html">Profile Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/interactionservice.html">IdentityServer Interaction Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/deviceflow_interactionservice.html">Device Flow Interaction Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/ef.html">Entity Framework Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/aspnet_identity.html">ASP.NET Identity Support</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">杂项</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../misc/training.html">Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/blogs.html">Blog posts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/videos.html">Videos</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">IdentityServer4</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Persisted Grants</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/topics/persisted_grants.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="persisted-grants">
<h1>Persisted Grants<a class="headerlink" href="#persisted-grants" title="永久链接至标题">¶</a></h1>
<p>Many grant types require persistence in IdentityServer.
These include authorization codes, refresh tokens, reference tokens, and remembered user consents.
Internally in IdentityServer, the default storage for these grants is in a common store called the persisted grants store.</p>
<div class="section" id="persisted-grant">
<h2>Persisted Grant<a class="headerlink" href="#persisted-grant" title="永久链接至标题">¶</a></h2>
<p>The persisted grant is the data type that maintains the values for a grant.
It has these properties:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">Key</span></code></dt><dd><p>The unique identifier for the persisted grant in the store.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">Type</span></code></dt><dd><p>The type of the grant.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">SubjectId</span></code></dt><dd><p>The subject id to which the grant belongs.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">ClientId</span></code></dt><dd><p>The client identifier for which the grant was created.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">Description</span></code></dt><dd><p>The description the user assigned to the grant or device being authorized.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">CreationTime</span></code></dt><dd><p>The date/time the grant was created.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">Expiration</span></code></dt><dd><p>The expiration of the grant.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">ConsumedTime</span></code></dt><dd><p>The date/time the grant was &quot;consumed&quot; (see below).</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">Data</span></code></dt><dd><p>The grant specific serialized data.</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Data</span></code> property contains a copy of all of the values (and more) and is considered authoritative by IdentityServer, thus the above values, by default, are considered informational and read-only.</p>
</div>
<p>The presence of the record in the store without a <code class="docutils literal notranslate"><span class="pre">ConsumedTime</span></code> and while still within the <code class="docutils literal notranslate"><span class="pre">Expiration</span></code> represents the validity of the grant.
Setting either of these two values, or removing the record from the store effectively revokes the grant.</p>
</div>
<div class="section" id="grant-consumption">
<h2>Grant Consumption<a class="headerlink" href="#grant-consumption" title="永久链接至标题">¶</a></h2>
<p>Some grant types are one-time use only (either by definition or configuration).
Once they are &quot;used&quot;, rather than deleting the record, the <code class="docutils literal notranslate"><span class="pre">ConsumedTime</span></code> value is set in the database marking them as having been used.
This &quot;soft delete&quot; allows for custom implementations to either have flexibility in allowing a grant to be re-used (typically within a short window of time),
or to be used in risk assessment and threat mitigation scenarios (where suspicious activity is detected) to revoke access.
For refresh tokens, this sort of custom logic would be performed in the <code class="docutils literal notranslate"><span class="pre">IRefreshTokenService</span></code>.</p>
</div>
<div class="section" id="persisted-grant-service">
<h2>Persisted Grant Service<a class="headerlink" href="#persisted-grant-service" title="永久链接至标题">¶</a></h2>
<p>Working with the grants store directly might be too low level.
As such, a higher level service called <code class="docutils literal notranslate"><span class="pre">IPersistedGrantService</span></code> is provided.
It abstracts and aggregates the different grant types into one concept, and allows querying and revoking the persisted grants for a user.</p>
<p>It contains these APIs:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">GetAllGrantsAsync</span></code></dt><dd><p>Gets all the grants for a user based upon subject id.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">RemoveAllGrantsAsync</span></code></dt><dd><p>Removes grants from the store based on the subject id and optionally a client id and/or a session id.</p>
</dd>
</dl>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="pop.html" class="btn btn-neutral float-right" title="Proof-of-Possession Access Tokens" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="reference_tokens.html" class="btn btn-neutral float-left" title="Reference Tokens" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; 版权所有 2020, Brock Allen &amp; Dominick Baier.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>