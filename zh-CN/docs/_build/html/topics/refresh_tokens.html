

<!DOCTYPE html>
<html class="writer-html5" lang="zh" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Refresh Tokens &mdash; IdentityServer4 1.0.0 文档</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
    <link rel="next" title="Reference Tokens" href="reference_tokens.html" />
    <link rel="prev" title="Resource Owner Password Validation" href="resource_owner.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> IdentityServer4
          

          
          </a>

          
            
            
              <div class="version">
                1.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">介绍</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../intro/big_picture.html">大图</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/terminology.html">术语</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/specs.html">支持的规范</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/packaging.html">打包和构建</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/support.html">支持和咨询选项</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/test.html">演示服务器</a></li>
<li class="toctree-l1"><a class="reference internal" href="../intro/contributing.html">贡献</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">快速入门</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quickstarts/0_overview.html">概述</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstarts/1_client_credentials.html">使用客户端凭据保护 API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstarts/2_interactive_aspnetcore.html">使用 ASP.NET Core 的交互式应用程序</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstarts/3_aspnetcore_and_apis.html">ASP.NET Core 和 API 访问</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstarts/4_javascript_client.html">添加 JavaScript 客户端</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstarts/5_entityframework.html">使用 EntityFramework Core 获取配置和操作数据</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstarts/6_aspnet_identity.html">使用 ASP.NET Core Identity</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">主题</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="startup.html">Startup</a></li>
<li class="toctree-l1"><a class="reference internal" href="resources.html">定义资源</a></li>
<li class="toctree-l1"><a class="reference internal" href="clients.html">定义客户端</a></li>
<li class="toctree-l1"><a class="reference internal" href="signin.html">登录</a></li>
<li class="toctree-l1"><a class="reference internal" href="signin_external_providers.html">使用外部身份提供商登录</a></li>
<li class="toctree-l1"><a class="reference internal" href="windows.html">Windows 身份验证</a></li>
<li class="toctree-l1"><a class="reference internal" href="signout.html">Sign-out</a></li>
<li class="toctree-l1"><a class="reference internal" href="signout_external_providers.html">Sign-out of External Identity Providers</a></li>
<li class="toctree-l1"><a class="reference internal" href="signout_federated.html">Federated Sign-out</a></li>
<li class="toctree-l1"><a class="reference internal" href="federation_gateway.html">Federation Gateway</a></li>
<li class="toctree-l1"><a class="reference internal" href="consent.html">Consent</a></li>
<li class="toctree-l1"><a class="reference internal" href="apis.html">Protecting APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="deployment.html">Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="logging.html">Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="events.html">Events</a></li>
<li class="toctree-l1"><a class="reference internal" href="crypto.html">Cryptography, Keys and HTTPS</a></li>
<li class="toctree-l1"><a class="reference internal" href="grant_types.html">Grant Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="client_authentication.html">Client Authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="extension_grants.html">Extension Grants</a></li>
<li class="toctree-l1"><a class="reference internal" href="resource_owner.html">Resource Owner Password Validation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Refresh Tokens</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#additional-client-settings">Additional client settings</a></li>
<li class="toctree-l2"><a class="reference internal" href="#requesting-a-refresh-token">Requesting a refresh token</a></li>
<li class="toctree-l2"><a class="reference internal" href="#requesting-an-access-token-using-a-refresh-token">Requesting an access token using a refresh token</a></li>
<li class="toctree-l2"><a class="reference internal" href="#customizing-refresh-token-behavior">Customizing refresh token behavior</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="reference_tokens.html">Reference Tokens</a></li>
<li class="toctree-l1"><a class="reference internal" href="persisted_grants.html">Persisted Grants</a></li>
<li class="toctree-l1"><a class="reference internal" href="pop.html">Proof-of-Possession Access Tokens</a></li>
<li class="toctree-l1"><a class="reference internal" href="mtls.html">Mutual TLS</a></li>
<li class="toctree-l1"><a class="reference internal" href="request_object.html">Authorize Request Objects</a></li>
<li class="toctree-l1"><a class="reference internal" href="custom_token_request_validation.html">Custom Token Request Validation and Issuance</a></li>
<li class="toctree-l1"><a class="reference internal" href="cors.html">CORS</a></li>
<li class="toctree-l1"><a class="reference internal" href="discovery.html">Discovery</a></li>
<li class="toctree-l1"><a class="reference internal" href="add_apis.html">Adding more API Endpoints</a></li>
<li class="toctree-l1"><a class="reference internal" href="add_protocols.html">Adding new Protocols</a></li>
<li class="toctree-l1"><a class="reference internal" href="tools.html">Tools</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">端点</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../endpoints/discovery.html">Discovery Endpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../endpoints/authorize.html">Authorize Endpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../endpoints/token.html">Token Endpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../endpoints/userinfo.html">UserInfo Endpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../endpoints/device_authorization.html">Device Authorization Endpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../endpoints/introspection.html">Introspection Endpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../endpoints/revocation.html">Revocation Endpoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../endpoints/endsession.html">End Session Endpoint</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">参考</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../reference/options.html">IdentityServer Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/identity_resource.html">Identity Resource</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/api_scope.html">API Scope</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/api_resource.html">API Resource</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/client.html">Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/grant_validation_result.html">GrantValidationResult</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/profileservice.html">Profile Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/interactionservice.html">IdentityServer Interaction Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/deviceflow_interactionservice.html">Device Flow Interaction Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/ef.html">Entity Framework Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/aspnet_identity.html">ASP.NET Identity Support</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">杂项</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../misc/training.html">Training</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/blogs.html">Blog posts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/videos.html">Videos</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">IdentityServer4</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Refresh Tokens</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/topics/refresh_tokens.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="refresh-tokens">
<h1>Refresh Tokens<a class="headerlink" href="#refresh-tokens" title="永久链接至标题">¶</a></h1>
<p>Since access tokens have finite lifetimes, refresh tokens allow requesting new access tokens without user interaction.</p>
<p>Refresh tokens are supported for the following flows: authorization code, hybrid and resource owner password credential flow.
The clients needs to be explicitly authorized to request refresh tokens by setting <code class="docutils literal notranslate"><span class="pre">AllowOfflineAccess</span></code> to <code class="docutils literal notranslate"><span class="pre">true</span></code>.</p>
<div class="section" id="additional-client-settings">
<h2>Additional client settings<a class="headerlink" href="#additional-client-settings" title="永久链接至标题">¶</a></h2>
<dl>
<dt><code class="docutils literal notranslate"><span class="pre">AbsoluteRefreshTokenLifetime</span></code></dt><dd><p>Maximum lifetime of a refresh token in seconds. Defaults to 2592000 seconds / 30 days. Zero allows refresh tokens that, when used with <code class="docutils literal notranslate"><span class="pre">RefreshTokenExpiration</span> <span class="pre">=</span> <span class="pre">Sliding</span></code> only expire after the SlidingRefreshTokenLifetime is passed.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">SlidingRefreshTokenLifetime</span></code></dt><dd><p>Sliding lifetime of a refresh token in seconds. Defaults to 1296000 seconds / 15 days</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">RefreshTokenUsage</span></code></dt><dd><p><code class="docutils literal notranslate"><span class="pre">ReUse</span></code> the refresh token handle will stay the same when refreshing tokens</p>
<p><code class="docutils literal notranslate"><span class="pre">OneTimeOnly</span></code> the refresh token handle will be updated when refreshing tokens</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">RefreshTokenExpiration</span></code></dt><dd><p><code class="docutils literal notranslate"><span class="pre">Absolute</span></code> the refresh token will expire on a fixed point in time (specified by the AbsoluteRefreshTokenLifetime). This is the default.</p>
<p><code class="docutils literal notranslate"><span class="pre">Sliding</span></code> when refreshing the token, the lifetime of the refresh token will be renewed (by the amount specified in SlidingRefreshTokenLifetime). The lifetime will not exceed <cite>AbsoluteRefreshTokenLifetime</cite>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">UpdateAccessTokenClaimsOnRefresh</span></code></dt><dd><p>Gets or sets a value indicating whether the access token (and its claims) should be updated on a refresh token request.</p>
</dd>
</dl>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>Public clients (clients without a client secret) should rotate their refresh tokens. Set the <code class="docutils literal notranslate"><span class="pre">RefreshTokenUsage</span></code> to <code class="docutils literal notranslate"><span class="pre">OneTimeOnly</span></code>.</p>
</div>
</div>
<div class="section" id="requesting-a-refresh-token">
<h2>Requesting a refresh token<a class="headerlink" href="#requesting-a-refresh-token" title="永久链接至标题">¶</a></h2>
<p>You can request a refresh token by adding a scope called <code class="docutils literal notranslate"><span class="pre">offline_access</span></code> to the scope parameter.</p>
</div>
<div class="section" id="requesting-an-access-token-using-a-refresh-token">
<h2>Requesting an access token using a refresh token<a class="headerlink" href="#requesting-an-access-token-using-a-refresh-token" title="永久链接至标题">¶</a></h2>
<p>To get a new access token, you send the refresh token to the token endpoint.
This will result in a new token response containing a new access token and its expiration and potentially also a new refresh token depending on the client configuration (see above).</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="n">POST</span> <span class="p">/</span><span class="n">connect</span><span class="p">/</span><span class="n">token</span>

    <span class="n">client_id</span><span class="p">=</span><span class="n">client</span><span class="p">&amp;</span>
    <span class="n">client_secret</span><span class="p">=</span><span class="n">secret</span><span class="p">&amp;</span>
    <span class="n">grant_type</span><span class="p">=</span><span class="n">refresh_token</span><span class="p">&amp;</span>
    <span class="n">refresh_token</span><span class="p">=</span><span class="n">hdh922</span>
</pre></div>
</div>
<p>(Form-encoding removed and line breaks added for readability)</p>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>You can use the <a class="reference external" href="https://github.com/IdentityModel/IdentityModel">IdentityModel</a> client library to programmatically access the token endpoint from .NET code. For more information check the IdentityModel <a class="reference external" href="https://identitymodel.readthedocs.io/en/latest/client/token.html">docs</a>.</p>
</div>
<div class="admonition note">
<p class="admonition-title">注解</p>
<p>The refresh token, must be valid or an invalid_grant error is returned.  By default, a refresh_token can only be used once.  Using an already used refresh_token will result in an invalid_grant error.</p>
</div>
</div>
<div class="section" id="customizing-refresh-token-behavior">
<h2>Customizing refresh token behavior<a class="headerlink" href="#customizing-refresh-token-behavior" title="永久链接至标题">¶</a></h2>
<p>All refresh token handling is implemented in the <code class="docutils literal notranslate"><span class="pre">DefaultRefreshTokenService</span></code> (which is the default implementation of the <code class="docutils literal notranslate"><span class="pre">IRefreshTokenService</span></code> interface):</p>
<div class="highlight-csharp notranslate"><div class="highlight"><pre><span></span><span class="k">public</span> <span class="k">interface</span> <span class="n">IRefreshTokenService</span>
<span class="p">{</span>
    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// Validates a refresh token.</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="n">Task</span><span class="p">&lt;</span><span class="n">TokenValidationResult</span><span class="p">&gt;</span> <span class="n">ValidateRefreshTokenAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">token</span><span class="p">,</span> <span class="n">Client</span> <span class="n">client</span><span class="p">);</span>

    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// Creates the refresh token.</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="n">Task</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">CreateRefreshTokenAsync</span><span class="p">(</span><span class="n">ClaimsPrincipal</span> <span class="n">subject</span><span class="p">,</span> <span class="n">Token</span> <span class="n">accessToken</span><span class="p">,</span> <span class="n">Client</span> <span class="n">client</span><span class="p">);</span>

    <span class="c1">/// &lt;summary&gt;</span>
    <span class="c1">/// Updates the refresh token.</span>
    <span class="c1">/// &lt;/summary&gt;</span>
    <span class="n">Task</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">UpdateRefreshTokenAsync</span><span class="p">(</span><span class="kt">string</span> <span class="n">handle</span><span class="p">,</span> <span class="n">RefreshToken</span> <span class="n">refreshToken</span><span class="p">,</span> <span class="n">Client</span> <span class="n">client</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The logic around refresh token handling is pretty involved, and we don't recommend implementing the interface from scratch,
unless you exactly know what you are doing.
If you want to customize certain behavior, it is more recommended to derive from the default implementation and call the base checks first.</p>
<p>The most common customization that you probably want to do is how to deal with refresh token replays.
This is for situations where the token usage has been set to one-time only, but the same token gets sent more than once.
This could either point to a replay attack of the refresh token, or to faulty client code like logic bugs or race conditions.</p>
<p>It is important to note, that a refresh token is never deleted in the database.
Once it has been used, the <code class="docutils literal notranslate"><span class="pre">ConsumedTime</span></code> property will be set.
If a token is received that has already been consumed, the default service will call a virtual method called <code class="docutils literal notranslate"><span class="pre">AcceptConsumedTokenAsync</span></code>.</p>
<p>The default implementation will reject the request, but here you can implement custom logic like grace periods,
or revoking additional refresh or access tokens.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="reference_tokens.html" class="btn btn-neutral float-right" title="Reference Tokens" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="resource_owner.html" class="btn btn-neutral float-left" title="Resource Owner Password Validation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; 版权所有 2020, Brock Allen &amp; Dominick Baier.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>